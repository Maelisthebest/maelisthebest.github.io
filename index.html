<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Login / Registrierung</title>
</head>
<body style="font-family: Arial; background: #f0f2f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0;">

    <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 350px;">
        <h2 style="text-align: center; color: #333;">Registrierung</h2>
        <input type="text" id="regUsername" placeholder="Wunsch-Username" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
        <input type="password" id="regPassword" placeholder="Passwort (min. 6 Zeichen)" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
        <button id="btnRegister" style="width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">Konto erstellen</button>
        <p id="regMessage" style="color: red; font-size: 13px; text-align: center;"></p>

        <hr style="margin: 25px 0; border: 0; border-top: 1px solid #eee;">

        <h2 style="text-align: center; color: #333;">Login</h2>
        <input type="text" id="loginUsername" placeholder="Username" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
        <input type="password" id="loginPassword" placeholder="Passwort" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
        <button id="btnLogin" style="width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">Anmelden</button>
        <p id="loginMessage" style="color: red; font-size: 13px; text-align: center;"></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCp6Aon4b-sLmUdRaf3sdyKN0y4QK2Zil4",
            authDomain: "maelist-chat.firebaseapp.com",
            databaseURL: "https://maelist-chat-default-rtdb.firebaseio.com/",
            projectId: "maelist-chat",
            storageBucket: "maelist-chat.firebasestorage.app",
            messagingSenderId: "87392900284",
            appId: "1:87392900284:web:fd39fe7161bfa828976cb9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        document.getElementById('btnRegister').onclick = async () => {
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value;
            if(!username || password.length < 6) return alert("Daten unvollstÃ¤ndig!");

            try {
                // 1. Erst Auth erstellen
                const cred = await createUserWithEmailAndPassword(auth, username.toLowerCase() + "@local.fake", password);
                const uid = cred.user.uid;

                // 2. In Database schreiben (Ordner und Username-Reservierung)
                await Promise.all([
                    set(ref(db, 'users/' + uid), { username: username }),
                    set(ref(db, 'usernames/' + username), uid)
                ]);

                window.location.href = "chat.html";
            } catch(err) {
                document.getElementById('regMessage').textContent = "Fehler: " + err.message;
            }
        };

        document.getElementById('btnLogin').onclick = async () => {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            try {
                await signInWithEmailAndPassword(auth, username.toLowerCase() + "@local.fake", password);
                window.location.href = "chat.html";
            } catch(err) {
                document.getElementById('loginMessage').textContent = "Login fehlgeschlagen!";
            }
        };
    </script>
</body>
</html>
