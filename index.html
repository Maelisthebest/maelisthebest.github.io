<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Login / Registrierung</title>
</head>
<body style="font-family: Arial; padding: 20px;">

    <h2>Registrierung</h2>
    <input type="text" id="regUsername" placeholder="Username">
    <input type="password" id="regPassword" placeholder="Passwort">
    <button id="btnRegister">Registrieren</button>
    <p id="regMessage" style="color: red;"></p>

    <hr>

    <h2>Login</h2>
    <input type="text" id="loginUsername" placeholder="Username">
    <input type="password" id="loginPassword" placeholder="Passwort">
    <button id="btnLogin">Login</button>
    <p id="loginMessage" style="color: red;"></p>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCp6Aon4b-sLmUdRaf3sdyKN0y4QK2Zil4",
            authDomain: "maelist-chat.firebaseapp.com",
            databaseURL: "https://maelist-chat-default-rtdb.firebaseio.com/",
            projectId: "maelist-chat",
            storageBucket: "maelist-chat.firebasestorage.app",
            messagingSenderId: "87392900284",
            appId: "1:87392900284:web:fd39fe7161bfa828976cb9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // REGISTRIERUNG
        document.getElementById('btnRegister').onclick = async () => {
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value;
            
            if(!username || !password) {
                alert("Bitte Username und Passwort eingeben");
                return;
            }

            // Wir erstellen eine interne Email-Adresse aus dem Usernamen
            const email = username.toLowerCase() + "@local.fake";

            try {
                // 1. PrÃ¼fen, ob der Username in der Database schon existiert
                const userCheckRef = ref(db, 'usernames/' + username);
                const snap = await get(userCheckRef);
                if(snap.exists()) {
                    document.getElementById('regMessage').textContent = "Username bereits vergeben!";
                    return;
                }

                // 2. Neuen Account in Firebase Auth erstellen
                const cred = await createUserWithEmailAndPassword(auth, email, password);
                const userUid = cred.user.uid;

                // 3. Den "Ordner" (User-Daten) in der Database anlegen
                await set(ref(db, 'users/' + userUid), {
                    username: username,
                    createdAt: Date.now()
                });

                // 4. Den Usernamen reservieren
                await set(ref(db, 'usernames/' + username), userUid);

                console.log("Registrierung erfolgreich!");
                window.location.href = "chat.html";

            } catch(err) {
                document.getElementById('regMessage').textContent = "Fehler: " + err.message;
            }
        };

        // LOGIN
        document.getElementById('btnLogin').onclick = async () => {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const email = username.toLowerCase() + "@local.fake";

            try {
                await signInWithEmailAndPassword(auth, email, password);
                window.location.href = "chat.html";
            } catch(err) {
                document.getElementById('loginMessage').textContent = "Login fehlgeschlagen!";
            }
        };
    </script>
</body>
</html>
