<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Login / Registrierung</title>
</head>
<body style="font-family: Arial; padding: 20px; background: #f0f2f5;">
    <div style="max-width: 400px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <h2>Registrierung</h2>
        <input type="text" id="regUsername" placeholder="Username" style="width: 90%; padding: 8px; margin-bottom: 10px;">
        <input type="password" id="regPassword" placeholder="Passwort" style="width: 90%; padding: 8px; margin-bottom: 10px;">
        <button id="btnRegister" style="width: 95%; padding: 10px; background: #007bff; color: white; border: none; cursor: pointer;">Registrieren</button>
        <p id="regMessage" style="color: red; font-size: 14px;"></p>

        <hr style="margin: 20px 0;">

        <h2>Login</h2>
        <input type="text" id="loginUsername" placeholder="Username" style="width: 90%; padding: 8px; margin-bottom: 10px;">
        <input type="password" id="loginPassword" placeholder="Passwort" style="width: 90%; padding: 8px; margin-bottom: 10px;">
        <button id="btnLogin" style="width: 95%; padding: 10px; background: #28a745; color: white; border: none; cursor: pointer;">Login</button>
        <p id="loginMessage" style="color: red; font-size: 14px;"></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCp6Aon4b-sLmUdRaf3sdyKN0y4QK2Zil4",
            authDomain: "maelist-chat.firebaseapp.com",
            databaseURL: "https://maelist-chat-default-rtdb.firebaseio.com/",
            projectId: "maelist-chat",
            storageBucket: "maelist-chat.firebasestorage.app",
            messagingSenderId: "87392900284",
            appId: "1:87392900284:web:fd39fe7161bfa828976cb9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        document.getElementById('btnRegister').onclick = async () => {
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value;
            
            if(!username || password.length < 6) {
                alert("Username eingeben & Passwort mind. 6 Zeichen!");
                return;
            }
        
            const email = username.toLowerCase() + "@local.fake";
        
            try {
                // 1. PrÃ¼fen, ob Name frei ist (Dank Rule .read:true jetzt erlaubt)
                const snap = await get(ref(db, 'usernames/' + username));
                if(snap.exists()) {
                    document.getElementById('regMessage').textContent = "Name schon vergeben!";
                    return;
                }
        
                // 2. Auth Account erstellen
                const cred = await createUserWithEmailAndPassword(auth, email, password);
                const userUid = cred.user.uid;
        
                // 3. Kurz warten (100ms), damit Firebase den Login registriert
                await new Promise(res => setTimeout(res, 100));
        
                // 4. In Database schreiben
                await set(ref(db, 'users/' + userUid), { username: username });
                await set(ref(db, 'usernames/' + username), userUid);
        
                window.location.href = "chat.html";
        
            } catch(err) {
                console.error("Fehler Details:", err);
                document.getElementById('regMessage').textContent = "Fehler: " + err.code;
            }
        };

        document.getElementById('btnLogin').onclick = async () => {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            try {
                await signInWithEmailAndPassword(auth, username.toLowerCase() + "@local.fake", password);
                window.location.href = "chat.html";
            } catch(err) { document.getElementById('loginMessage').textContent = "Login fehlgeschlagen!"; }
        };
    </script>
</body>
</html>
