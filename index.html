<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Login / Registrierung</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
body { font-family: Arial; text-align:center; margin-top:50px; }
input, button { padding:8px; margin:5px; width:250px; }
</style>
</head>
<body>

<h2>ğŸ” Login / Registrierung</h2>

<input type="text" id="username" placeholder="Benutzername"><br>
<input type="password" id="password" placeholder="Passwort"><br>

<button onclick="register()">Registrieren</button><br>
<button onclick="login()">Login</button><br>

<p id="message" style="color:red"></p>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCp6Aon4b-sLmUdRaf3sdyKN0y4QK2Zil4",
  authDomain: "maelist-chat.firebaseapp.com",
  databaseURL: "https://maelist-chat-default-rtdb.firebaseio.com/",
  projectId: "maelist-chat",
  storageBucket: "maelist-chat.firebasestorage.app",
  messagingSenderId: "87392900284",
  appId: "1:87392900284:web:fd39fe7161bfa828976cb9",
  measurementId: "G-GK0KNPV152"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// Registrierung
function register() {
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value;
  if(!username || !password){ alert("Alle Felder ausfÃ¼llen"); return; }

  const email = username + "@local.fake";

  // PrÃ¼fen, ob Username schon existiert
  db.ref('usernames/' + username).get().then(snap => {
    if(snap.exists()){
      document.getElementById('message').textContent = "Username existiert bereits";
    } else {
      auth.createUserWithEmailAndPassword(email, password)
        .then(cred => {
          // Zuerst Username speichern
          return db.ref('users/' + cred.user.uid).set({ username: username })
            .then(() => db.ref('usernames/' + username).set(cred.user.uid));
        })
        .then(() => {
          // Erst nachdem alles gespeichert ist, weiterleiten
          window.location.href = "chat.html";
        })
        .catch(err => document.getElementById('message').textContent = err.message);
    }
  });
}

// Login
function login() {
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value;
  if(!username || !password){ alert("Alle Felder ausfÃ¼llen"); return; }

  const email = username + "@local.fake";

  auth.signInWithEmailAndPassword(email, password)
    .then(cred => {
      // PrÃ¼fen, ob Username in DB existiert, sonst speichern (sicher)
      db.ref('users/' + cred.user.uid).get().then(snap => {
        if(!snap.exists() || !snap.val().username){
          // Username neu speichern, falls fehlt
          db.ref('users/' + cred.user.uid).set({ username: username });
          db.ref('usernames/' + username).set(cred.user.uid);
        }
        window.location.href = "chat.html";
      });
    })
    .catch(err => document.getElementById('message').textContent = err.message);
}

// PrÃ¼fen, ob schon eingeloggt
auth.onAuthStateChanged(user => {
  if(user) window.location.href = "chat.html";
});
</script>
</body>
</html>
