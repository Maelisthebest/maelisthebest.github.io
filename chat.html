<div id="chatSelect">
  <h3>Wähle einen Benutzer für neuen Chat:</h3>
  <input type="text" id="chatWith" placeholder="Benutzername" />
  <button onclick="createChat()">Chat erstellen</button>
</div>

<div id="chatWindow" style="display:none;">
  <h3>Chat mit <span id="chatPartner"></span></h3>
  <div id="messages" style="border:1px solid #ccc; height:200px; overflow:auto;"></div>
  <input type="text" id="msgInput" placeholder="Nachricht..." />
  <button onclick="sendMessage()">Senden</button>
  <button onclick="closeChat()">Schließen</button>
</div>

<script>
// Firebase Referenzen
const chatsRef = firebase.database().ref('chats');
const usersRef = firebase.database().ref('users');
const activeRef = firebase.database().ref('activeUsers');

let currentUser = localStorage.getItem('loggedUser');
let currentChatId = null;
let chatPartner = null;

// Chat erstellen / öffnen
function createChat() {
  const otherUser = document.getElementById('chatWith').value.trim();
  if(!otherUser || otherUser === currentUser) return alert("Ungültiger Benutzer");

  usersRef.child(otherUser).get().then(snap => {
    if(!snap.exists()) return alert("Benutzer existiert nicht");

    // Eindeutige Chat-ID: alphabetisch sortierte Usernamen
    const ids = [currentUser, otherUser].sort();
    const chatId = ids.join('_');

    chatsRef.child(chatId).get().then(chatSnap => {
      if(!chatSnap.exists()) {
        chatsRef.child(chatId).set({ users: ids, messages: {} });
      }
      currentChatId = chatId;
      chatPartner = otherUser;
      openChat();
    });
  });
}

// Chat öffnen
function openChat() {
  document.getElementById('chatSelect').style.display = 'none';
  document.getElementById('chatWindow').style.display = 'block';
  document.getElementById('chatPartner').textContent = chatPartner;
  loadMessages();
}

// Nachrichten laden
function loadMessages() {
  if(!currentChatId) return;
  const msgDiv = document.getElementById('messages');
  msgDiv.innerHTML = '';

  chatsRef.child(currentChatId).child('messages').on('child_added', snap => {
    const m = snap.val();
    const line = document.createElement('div');
    line.textContent = `${m.from}: ${m.text}`;
    msgDiv.appendChild(line);
    msgDiv.scrollTop = msgDiv.scrollHeight;
  });
}

// Nachricht senden
function sendMessage() {
  const text = document.getElementById('msgInput').value.trim();
  if(!text || !currentChatId) return;
  const msgId = Date.now(); // einfache eindeutige ID
  chatsRef.child(currentChatId).child('messages').child(msgId).set({
    from: currentUser,
    text: text,
    timestamp: msgId
  });
  document.getElementById('msgInput').value = '';
}

// Chat schließen
function closeChat() {
  currentChatId = null;
  chatPartner = null;
  document.getElementById('chatWindow').style.display = 'none';
  document.getElementById('chatSelect').style.display = 'block';
  document.getElementById('messages').innerHTML = '';
}
</script>
