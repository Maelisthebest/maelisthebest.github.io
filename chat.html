<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Mael Chat</title>
<style>
  body { font-family: Arial; max-width: 1000px; margin: auto; }
  #left, #right { display:inline-block; vertical-align:top; }
  #left { width:30%; }
  #right { width:65%; margin-left:2%; }
  #messages { border:1px solid #ccc; height:400px; overflow-y:auto; padding:5px; }
  li { cursor:pointer; margin:5px 0; }
  li:hover { background:#eee; }
</style>
</head>
<body>

<h2>ðŸ’¬ Chat System</h2>
<p>Eingeloggt als <b id="currentUser"></b></p>
<button onclick="logout()">Logout</button>

<div id="left">
  <h3>Ã–ffentlicher Chat</h3>
  <button onclick="openPublicChat()">Ã–ffnen</button>

  <h3>Meine Chats</h3>
  <ul id="myChats"></ul>

  <h3>Alle Benutzer</h3>
  <ul id="allUsers"></ul>
</div>

<div id="right">
  <h3 id="chatTitle">Kein Chat geÃ¶ffnet</h3>
  <div id="messages"></div>
  <input type="text" id="msgInput" placeholder="Nachricht..." style="width:80%;">
  <button onclick="sendMessage()">Senden</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCp6Aon4b-sLmUdRaf3sdyKN0y4QK2Zil4",
  authDomain: "maelist-chat.firebaseapp.com",
  databaseURL: "https://maelist-chat-default-rtdb.firebaseio.com/",
  projectId: "maelist-chat",
  storageBucket: "maelist-chat.firebasestorage.app",
  messagingSenderId: "87392900284",
  appId: "1:87392900284:web:fd39fe7161bfa828976cb9"
};

firebase.initializeApp(firebaseConfig);

const db = firebase.database();
const usersRef = db.ref("users");
const chatsRef = db.ref("chats");
const activeRef = db.ref("activeUsers");

let currentUser = localStorage.getItem("loggedUser");
let currentChatId = null;

if(!currentUser){
  alert("Bitte zuerst einloggen!");
  window.location.href = "index.html";
}

activeRef.child(currentUser).get().then(snap=>{
  if(!snap.exists()){
    alert("Nicht aktiv eingeloggt.");
    localStorage.removeItem("loggedUser");
    window.location.href="index.html";
  } else {
    document.getElementById("currentUser").textContent = currentUser;
    loadUsers();
    loadMyChats();
  }
});

function loadUsers(){
  usersRef.on("value", snap=>{
    const list = document.getElementById("allUsers");
    list.innerHTML="";
    snap.forEach(child=>{
      const name = child.key;
      if(name !== currentUser){
        const li = document.createElement("li");
        li.textContent = name;
        li.onclick = ()=>createOrOpenPrivateChat(name);
        list.appendChild(li);
      }
    });
  });
}

function loadMyChats(){
  chatsRef.on("value", snap=>{
    const list = document.getElementById("myChats");
    list.innerHTML="";
    snap.forEach(chat=>{
      const id = chat.key;
      const data = chat.val();
      if(id==="public") return;

      if(data.users && data.users.includes(currentUser)){
        const other = data.users.find(u=>u!==currentUser);
        const li = document.createElement("li");
        li.textContent = other;
        li.onclick = ()=>openChat(id, other);
        list.appendChild(li);
      }
    });
  });
}

function createOrOpenPrivateChat(otherUser){
  const ids = [currentUser, otherUser].sort();
  const chatId = ids.join("_");

  chatsRef.child(chatId).get().then(snap=>{
    if(!snap.exists()){
      chatsRef.child(chatId).set({
        users: ids,
        messages: {}
      });
    }
    openChat(chatId, otherUser);
  });
}

function openPublicChat(){
  chatsRef.child("public").get().then(snap=>{
    if(!snap.exists()){
      chatsRef.child("public").set({ messages:{} });
    }
    openChat("public","Ã–ffentlicher Chat");
  });
}

function openChat(chatId, title){
  currentChatId = chatId;
  document.getElementById("chatTitle").textContent = title;
  const msgDiv = document.getElementById("messages");
  msgDiv.innerHTML="";

  chatsRef.child(chatId).child("messages")
    .off();

  chatsRef.child(chatId).child("messages")
    .on("child_added", snap=>{
      const m = snap.val();
      const line = document.createElement("div");
      line.textContent = m.from + ": " + m.text;
      msgDiv.appendChild(line);
      msgDiv.scrollTop = msgDiv.scrollHeight;
    });
}

function sendMessage(){
  if(!currentChatId) return;
  const text = document.getElementById("msgInput").value.trim();
  if(!text) return;

  const id = Date.now();
  chatsRef.child(currentChatId).child("messages").child(id).set({
    from: currentUser,
    text: text,
    timestamp: id
  });

  document.getElementById("msgInput").value="";
}

function logout(){
  activeRef.child(currentUser).remove();
  localStorage.removeItem("loggedUser");
  window.location.href="index.html";
}
</script>
</body>
</html>
