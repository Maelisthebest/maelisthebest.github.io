<!DOCTYPE html>
<html>
<head>
    <title>Chat</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getDatabase, ref, set, get, push, onChildAdded, onValue, onDisconnect, off } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCp6Aon4b-sLmUdRaf3sdyKN0y4QK2Zil4",
            authDomain: "maelist-chat.firebaseapp.com",
            databaseURL: "https://maelist-chat-default-rtdb.firebaseio.com/",
            projectId: "maelist-chat",
            storageBucket: "maelist-chat.firebasestorage.app",
            messagingSenderId: "87392900284",
            appId: "1:87392900284:web:fd39fe7161bfa828976cb9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let uid, username, currentChat = "public", currentListenRef = null;

        function getChatId(uid1, uid2) {
            return [uid1, uid2].sort().join("_");
        }

        onAuthStateChanged(auth, async (user) => {
            if (!user) { window.location.href = "index.html"; return; }
            uid = user.uid;
            const userSnap = await get(ref(db, "users/" + uid));
            username = userSnap.val()?.username || "Anonym";

            const onlineRef = ref(db, "online/" + uid);
            set(onlineRef, true);
            onDisconnect(onlineRef).remove();

            loadUsers();
            openChat("public");
        });

        function loadUsers() {
            onValue(ref(db, "users"), async (snapshot) => {
                const list = document.getElementById("users");
                list.innerHTML = "";
                const onlineSnap = await get(ref(db, "online"));
                const onlineUsers = onlineSnap.val() || {};

                snapshot.forEach(child => {
                    if (child.key === uid) return;
                    const isOnline = onlineUsers[child.key];
                    const div = document.createElement("div");
                    div.style.padding = "5px";
                    div.style.cursor = "pointer";
                    div.innerHTML = `<span style="color:${isOnline ? "lime" : "gray"}">‚óè</span> ${child.val().username}`;
                    div.onclick = () => startPrivateChat(child.key);
                    list.appendChild(div);
                });
            });
        }

        async function startPrivateChat(otherUid) {
            const chatId = getChatId(uid, otherUid);
            const chatRef = ref(db, "chats/" + chatId);
            const snap = await get(chatRef);

            if (!snap.exists()) {
                await set(chatRef, { members: { [uid]: true, [otherUid]: true } });
            }
            openChat(chatId);
        }

        window.openChat = function(chatId) {
            if (currentListenRef) off(currentListenRef);
            currentChat = chatId;
            document.getElementById("messages").innerHTML = `<b>Chat: ${chatId}</b><br>`;

            const messagesRef = ref(db, `chats/${chatId}/messages`);
            currentListenRef = messagesRef;

            onChildAdded(messagesRef, (snapshot) => {
                const m = snapshot.val();
                const div = document.createElement("div");
                div.innerHTML = `<strong>${m.from}:</strong> ${m.text}`;
                document.getElementById("messages").appendChild(div);
                document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
            });
        }

        window.sendMessage = function() {
            const input = document.getElementById("msg");
            if (!input.value) return;
            push(ref(db, `chats/${currentChat}/messages`), {
                from: username,
                text: input.value,
                timestamp: Date.now()
            });
            input.value = "";
        }
    </script>
</head>
<body style="display:flex; height:100vh; font-family:Arial; margin:0;">
    <div style="width:200px; border-right:1px solid #ccc; padding:10px; background:#f4f4f4;">
        <h3>Nutzer</h3>
        <div id="users"></div>
        <hr>
        <button onclick="openChat('public')" style="width:100%">üåç Public Chat</button>
    </div>
    <div style="flex:1; display:flex; flex-direction:column;">
        <div id="messages" style="flex:1; overflow:auto; padding:20px; background:#fff;"></div>
        <div style="padding:10px; border-top:1px solid #ccc; display:flex;">
            <input id="msg" style="flex:1; padding:10px;" placeholder="Nachricht..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()" style="padding:10px 20px;">Senden</button>
        </div>
    </div>
</body>
</html>
