<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Chat</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<p>Willkommen, <span id="username">Lade...</span>!</p>
<input type="text" id="msgInput" placeholder="Nachricht..." disabled>
<button id="sendBtn" disabled onclick="sendMessage()">Senden</button>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCp6Aon4b-sLmUdRaf3sdyKN0y4QK2Zil4",
  authDomain: "maelist-chat.firebaseapp.com",
  databaseURL: "https://maelist-chat-default-rtdb.firebaseio.com/",
  projectId: "maelist-chat",
  storageBucket: "maelist-chat.firebasestorage.app",
  messagingSenderId: "87392900284",
  appId: "1:87392900284:web:fd39fe7161bfa828976cb9",
  measurementId: "G-GK0KNPV152"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
let username = null;
let uid = null;

// WICHTIG: auth.onAuthStateChanged muss warten, bis Auth geladen ist
auth.onAuthStateChanged(user => {
  if(!user){
    window.location.href = "index.html";
    return;
  }
  uid = user.uid;

  // Username einmalig aus DB laden
  db.ref('users/' + uid).once('value')
    .then(snap => {
      const data = snap.val();
      if(data && data.username){
        username = data.username;
        document.getElementById('username').textContent = username;

        // Jetzt Nachrichteneingabe freischalten
        document.getElementById('msgInput').disabled = false;
        document.getElementById('sendBtn').disabled = false;

      } else {
        alert("Fehler: Username nicht gefunden!");
      }
    })
    .catch(err => {
      console.error("DB Fehler:", err);
      alert("Fehler beim Laden des Usernames!");
    });
});

// Nachricht senden
function sendMessage(){
  if(!username) return alert("Username wird noch geladen!");
  const text = document.getElementById('msgInput').value;
  if(!text) return;

  db.ref('chats/public/messages').push().set({
    from: username,
    text: text,
    timestamp: Date.now()
  });

  document.getElementById('msgInput').value = "";
}
</script>
</body>
</html>
