<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Mael Chat</title>
<style>
  body { font-family: Arial; max-width: 800px; margin: auto; text-align: center; }
  input { padding: 5px; margin: 5px; width: 200px; }
  button { padding: 5px; margin: 5px; }
  #messages { border: 1px solid #ccc; height: 300px; overflow-y: auto; margin: 10px 0; text-align: left; padding: 5px;}
  #chatSelect, #chatWindow { border: 1px solid #ccc; padding: 10px; margin: 10px; display: inline-block; vertical-align: top; }
</style>
</head>
<body>
<h1>ðŸ’¬ Chat</h1>
<p>Eingeloggt als <span id="currentUser"></span></p>
<button onclick="logout()">Abmelden</button>

<div id="chatSelect">
  <h3>Neuen Chat erstellen:</h3>
  <input type="text" id="chatWith" placeholder="Benutzername" />
  <button onclick="createChat()">Chat erstellen</button>
</div>

<div id="chatWindow" style="display:none;">
  <h3>Chat mit <span id="chatPartner"></span></h3>
  <div id="messages"></div>
  <input type="text" id="msgInput" placeholder="Nachricht..." />
  <button onclick="sendMessage()">Senden</button>
  <button onclick="closeChat()">SchlieÃŸen</button>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// Firebase Konfiguration
const firebaseConfig = {
  apiKey: "AIzaSyCp6Aon4b-sLmUdRaf3sdyKN0y4QK2Zil4",
  authDomain: "maelist-chat.firebaseapp.com",
  databaseURL: "https://maelist-chat-default-rtdb.firebaseio.com/",
  projectId: "maelist-chat",
  storageBucket: "maelist-chat.firebasestorage.app",
  messagingSenderId: "87392900284",
  appId: "1:87392900284:web:fd39fe7161bfa828976cb9",
  measurementId: "G-GK0KNPV152"
};
firebase.initializeApp(firebaseConfig);

const db = firebase.database();
const usersRef = db.ref('users');
const activeRef = db.ref('activeUsers');
const chatsRef = db.ref('chats');

let currentUser = localStorage.getItem('loggedUser');
let currentChatId = null;
let chatPartner = null;

// PrÃ¼fen, ob Benutzer eingeloggt ist
if(!currentUser) {
  alert("Bitte zuerst einloggen!");
  window.location.href = "index.html";
} else {
  activeRef.child(currentUser).get().then(snap => {
    if(!snap.exists()) {
      alert("Du bist auf diesem GerÃ¤t nicht aktiv. Bitte einloggen.");
      localStorage.removeItem('loggedUser');
      window.location.href = "index.html";
    } else {
      document.getElementById('currentUser').textContent = currentUser;
    }
  });
}

// Chat erstellen / Ã¶ffnen
function createChat() {
  const otherUser = document.getElementById('chatWith').value.trim();
  if(!otherUser || otherUser === currentUser) return alert("UngÃ¼ltiger Benutzer");

  usersRef.child(otherUser).get().then(snap => {
    if(!snap.exists()) return alert("Benutzer existiert nicht");

    // Eindeutige Chat-ID: alphabetisch sortierte Usernamen
    const ids = [currentUser, otherUser].sort();
    const chatId = ids.join('_');

    chatsRef.child(chatId).get().then(chatSnap => {
      if(!chatSnap.exists()) {
        chatsRef.child(chatId).set({ users: ids, messages: {} });
      }
      currentChatId = chatId;
      chatPartner = otherUser;
      openChat();
    });
  });
}

// Chat Ã¶ffnen
function openChat() {
  document.getElementById('chatSelect').style.display = 'none';
  document.getElementById('chatWindow').style.display = 'block';
  document.getElementById('chatPartner').textContent = chatPartner;
  loadMessages();
}

// Nachrichten laden
function loadMessages() {
  if(!currentChatId) return;
  const msgDiv = document.getElementById('messages');
  msgDiv.innerHTML = '';

  chatsRef.child(currentChatId).child('messages').on('child_added', snap => {
    const m = snap.val();
    const line = document.createElement('div');
    line.textContent = `${m.from}: ${m.text}`;
    msgDiv.appendChild(line);
    msgDiv.scrollTop = msgDiv.scrollHeight;
  });
}

// Nachricht senden
function sendMessage() {
  const text = document.getElementById('msgInput').value.trim();
  if(!text || !currentChatId) return;
  const msgId = Date.now(); // einfache eindeutige ID
  chatsRef.child(currentChatId).child('messages').child(msgId).set({
    from: currentUser,
    text: text,
    timestamp: msgId
  });
  document.getElementById('msgInput').value = '';
}

// Chat schlieÃŸen
function closeChat() {
  currentChatId = null;
  chatPartner = null;
  document.getElementById('chatWindow').style.display = 'none';
  document.getElementById('chatSelect').style.display = 'block';
  document.getElementById('messages').innerHTML = '';
}

// Logout
function logout() {
  if(currentUser) activeRef.child(currentUser).remove();
  localStorage.removeItem('loggedUser');
  window.location.href = "index.html";
}
</script>
</body>
</html>
