<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Maelist Chat</title>
</head>
<body style="display: flex; height: 100vh; font-family: 'Segoe UI', Arial; margin: 0; background: #e5ddd5;">

    <div style="width: 300px; border-right: 1px solid #ccc; background: white; display: flex; flex-direction: column;">
        <div style="padding: 20px; background: #075e54; color: white; font-weight: bold; font-size: 18px;">Kontakte</div>
        <div id="users" style="flex: 1; overflow-y: auto;">
            <div style="padding: 20px; color: gray;">Lade Nutzer...</div>
        </div>
        <div style="padding: 10px; background: #f0f0f0; border-top: 1px solid #ddd;">
            <button onclick="openChat('public')" style="width: 100%; padding: 10px; background: #25d366; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-bottom: 5px;">üåç Globaler Chat</button>
            <button id="btnLogout" style="width: 100%; padding: 10px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">Abmelden</button>
        </div>
    </div>

    <div style="flex: 1; display: flex; flex-direction: column;">
        <div id="chatHeader" style="padding: 15px; background: #ededed; border-bottom: 1px solid #ccc; font-weight: bold;">W√§hle einen Chat aus...</div>
        <div id="messages" style="flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; background: #e5ddd5;"></div>
        
        <div id="inputArea" style="padding: 15px; background: #f0f0f0; display: flex; align-items: center;">
            <input id="msg" style="flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 20px; outline: none;" placeholder="Nachricht schreiben..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()" style="margin-left: 10px; padding: 10px 20px; background: #075e54; color: white; border: none; border-radius: 50px; cursor: pointer;">Senden</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getDatabase, ref, set, get, push, onChildAdded, onValue, onDisconnect, off } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCp6Aon4b-sLmUdRaf3sdyKN0y4QK2Zil4",
            authDomain: "maelist-chat.firebaseapp.com",
            databaseURL: "https://maelist-chat-default-rtdb.firebaseio.com/",
            projectId: "maelist-chat",
            storageBucket: "maelist-chat.firebasestorage.app",
            messagingSenderId: "87392900284",
            appId: "1:87392900284:web:fd39fe7161bfa828976cb9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let uid, username, currentChat = null, currentListenRef = null;

        onAuthStateChanged(auth, async (user) => {
            if (!user) { 
                window.location.href = "index.html"; 
                return; 
            }
            
            uid = user.uid;
        
            try {
                // Wir warten erst, bis wir das Profil geladen haben.
                // Das gibt der Verbindung Zeit, den Auth-Status zu festigen.
                const userSnap = await get(ref(db, "users/" + uid));
                
                if (userSnap.exists()) {
                    username = userSnap.val().username;
                    
                    // Erst JETZT setzen wir den Online-Status
                    const onlineRef = ref(db, "online/" + uid);
                    await set(onlineRef, true);
                    onDisconnect(onlineRef).remove();
                    
                    loadUsers();
                    openChat("public");
                } else {
                    console.error("User-Daten nicht gefunden. Vielleicht noch nicht in /users registriert?");
                    // Notfall-Logout, falls der Auth-User existiert, aber kein DB-Eintrag da ist
                    // signOut(auth);
                }
            } catch (err) {
                console.warn("Warte auf Datenbank-Berechtigung... probiere es gleich nochmal.");
                // Kleiner Delay-Retry, falls es beim ersten Mal kracht
                setTimeout(() => location.reload(), 1000);
            }
        });

        function loadUsers() {
            onValue(ref(db, "users"), (uSnap) => {
                onValue(ref(db, "online"), (oSnap) => {
                    const list = document.getElementById("users");
                    list.innerHTML = "";
                    const onlineData = oSnap.val() || {};

                    uSnap.forEach(child => {
                        if (child.key === uid) return;
                        const other = child.val();
                        const isOnline = onlineData[child.key] === true;

                        const div = document.createElement("div");
                        div.style = "padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center; background: white;";
                        div.innerHTML = `
                            <div style="width: 10px; height: 10px; border-radius: 50%; background: ${isOnline ? '#25d366' : '#bbb'}; margin-right: 15px;"></div>
                            <div style="font-weight: 500;">${other.username}</div>
                        `;
                        div.onclick = () => startPrivateChat(child.key, other.username);
                        list.appendChild(div);
                    });
                });
            });
        }

        async function startPrivateChat(otherUid, otherName) {
            const chatId = [uid, otherUid].sort().join("_");
            const chatRef = ref(db, "chats/" + chatId);
            
            try {
                const snap = await get(chatRef);
                if (!snap.exists()) {
                    // WICHTIG: Erstellt die Basis-Struktur mit Mitgliedern
                    await set(chatRef, { members: { [uid]: true, [otherUid]: true } });
                }
                openChat(chatId, otherName);
            } catch (err) {
                console.error("Chat-Start Fehler:", err);
                openChat(chatId, otherName); // Trotzdem versuchen zu √∂ffnen
            }
        }

        window.openChat = function(chatId, displayName = "üåç Globaler Chat") {
            // Alten Listener entfernen, falls vorhanden
            if (currentListenRef) off(currentListenRef);
            
            currentChat = chatId;
            document.getElementById("chatHeader").textContent = displayName;
            const msgBox = document.getElementById("messages");
            msgBox.innerHTML = "";

            // Wir h√∂ren auf den Unterordner /messages
            const messagesPath = chatId === "public" ? "chats/public/messages" : `chats/${chatId}/messages`;
            const messagesRef = ref(db, messagesPath);
            currentListenRef = messagesRef;

            onChildAdded(messagesRef, (snapshot) => {
                const m = snapshot.val();
                const isMe = m.from === username;
                const div = document.createElement("div");
                div.style = `padding: 8px 12px; margin-bottom: 8px; border-radius: 8px; max-width: 70%; font-size: 14.5px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
                            ${isMe ? 'align-self: flex-end; background: #dcf8c6;' : 'align-self: flex-start; background: white;'}`;
                div.innerHTML = `<small style="color: #075e54; font-weight:bold; display: block;">${m.from}</small>${m.text}`;
                msgBox.appendChild(div);
                msgBox.scrollTop = msgBox.scrollHeight;
            });
        }

        window.sendMessage = function() {
            const input = document.getElementById("msg");
            const text = input.value.trim();
            if (!text || !currentChat) return;

            const messagesPath = currentChat === "public" ? "chats/public/messages" : `chats/${currentChat}/messages`;
            
            // push() erzeugt eine neue ID f√ºr jede Nachricht
            push(ref(db, messagesPath), {
                from: username,
                text: text,
                timestamp: Date.now()
            });
            input.value = "";
        }

        document.getElementById("btnLogout").onclick = () => signOut(auth);
    </script>
</body>
</html>
