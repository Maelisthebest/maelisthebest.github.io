<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Maelist Chat - Safe Edition</title>
</head>
<body style="display: flex; height: 100vh; font-family: 'Segoe UI', Arial; margin: 0; background: #e5ddd5;">

    <div style="width: 300px; border-right: 1px solid #ccc; background: white; display: flex; flex-direction: column;">
        <div style="padding: 20px; background: #075e54; color: white; font-weight: bold; font-size: 18px;">Kontakte</div>
        <div id="users" style="flex: 1; overflow-y: auto;"></div>
        <div style="padding: 10px; background: #f0f0f0; border-top: 1px solid #ddd;">
            <button onclick="openChat('public')" style="width: 100%; padding: 10px; background: #25d366; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-bottom: 5px;">üåç Globaler Chat</button>
            <button id="btnLogout" style="width: 100%; padding: 10px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">Abmelden</button>
        </div>
    </div>

    <div style="flex: 1; display: flex; flex-direction: column;">
        <div id="chatHeader" style="padding: 15px; background: #ededed; border-bottom: 1px solid #ccc; font-weight: bold;">W√§hle einen Chat aus...</div>
        <div id="messages" style="flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; background: #e5ddd5;"></div>
        <div id="inputArea" style="padding: 15px; background: #f0f0f0; display: flex;">
            <input id="msg" style="flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 20px; outline: none;" placeholder="Nachricht..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()" style="margin-left: 10px; padding: 10px 20px; background: #075e54; color: white; border: none; border-radius: 50px; cursor: pointer;">Senden</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getDatabase, ref, set, get, push, onChildAdded, onValue, onDisconnect, off } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCp6Aon4b-sLmUdRaf3sdyKN0y4QK2Zil4",
            authDomain: "maelist-chat.firebaseapp.com",
            databaseURL: "https://maelist-chat-default-rtdb.firebaseio.com/",
            projectId: "maelist-chat",
            storageBucket: "maelist-chat.firebasestorage.app",
            messagingSenderId: "87392900284",
            appId: "1:87392900284:web:fd39fe7161bfa828976cb9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let uid, username, currentChat = null, currentListenRef = null;

        onAuthStateChanged(auth, async (user) => {
            if (!user) { window.location.href = "index.html"; return; }
            uid = user.uid;
            
            const userSnap = await get(ref(db, "users/" + uid));
            if (userSnap.exists()) {
                username = userSnap.val().username;
                set(ref(db, "online/" + uid), true);
                onDisconnect(ref(db, "online/" + uid)).remove();
                loadUsers();
                openChat("public");
            }
        });

        function loadUsers() {
            onValue(ref(db, "users"), (uSnap) => {
                onValue(ref(db, "online"), (oSnap) => {
                    const list = document.getElementById("users");
                    list.innerHTML = "";
                    const onlineData = oSnap.val() || {};
                    uSnap.forEach(child => {
                        if (child.key === uid) return;
                        const other = child.val();
                        const isOnline = onlineData[child.key] === true;
                        const div = document.createElement("div");
                        div.style = "padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center; background: white;";
                        div.innerHTML = `<div style="width: 10px; height: 10px; border-radius: 50%; background: ${isOnline ? '#25d366' : '#bbb'}; margin-right: 15px;"></div><b>${other.username}</b>`;
                        div.onclick = () => startPrivateChat(child.key, other.username);
                        list.appendChild(div);
                    });
                });
            });
        }

        async function startPrivateChat(otherUid, otherName) {
            const chatId = [uid, otherUid].sort().join("_");
            const chatRef = ref(db, "chats/" + chatId);
            
            try {
                const snap = await get(chatRef);
                if (!snap.exists()) {
                    // Chat erstellen: Nur m√∂glich, wenn eigene UID im Pfad ist (dank Rules!)
                    await set(chatRef, { members: { [uid]: true, [otherUid]: true } });
                }
                openChat(chatId, otherName);
            } catch (err) {
                console.warn("Zutritt verweigert oder Chat l√§dt noch...");
                openChat(chatId, otherName);
            }
        }

        window.openChat = function(chatId, displayName = "üåç Globaler Chat") {
            if (currentListenRef) off(currentListenRef);
            currentChat = chatId;
            document.getElementById("chatHeader").textContent = displayName;
            const msgBox = document.getElementById("messages");
            msgBox.innerHTML = "";

            const path = chatId === "public" ? "chats/public/messages" : `chats/${chatId}/messages`;
            currentListenRef = ref(db, path);

            onChildAdded(currentListenRef, (snap) => {
                const m = snap.val();
                const isMe = m.from === username;
                const div = document.createElement("div");
                div.style = `padding: 10px; margin: 5px; border-radius: 10px; max-width: 70%; ${isMe ? 'align-self: flex-end; background: #dcf8c6;' : 'align-self: flex-start; background: white;'}`;
                div.innerHTML = `<small style="display:block; color:green; font-weight:bold;">${m.from}</small>${m.text}`;
                msgBox.appendChild(div);
                msgBox.scrollTop = msgBox.scrollHeight;
            });
        }

        window.sendMessage = function() {
            const input = document.getElementById("msg");
            if (!input.value.trim() || !currentChat) return;
            const path = currentChat === "public" ? "chats/public/messages" : `chats/${currentChat}/messages`;
            push(ref(db, path), { from: username, text: input.value.trim(), timestamp: Date.now() });
            input.value = "";
        }

        document.getElementById("btnLogout").onclick = () => signOut(auth);
    </script>
</body>
</html>
