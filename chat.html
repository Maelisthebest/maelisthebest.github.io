<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Multi-User Chat</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
#chatList button { margin: 2px; }
.chatBox { border:1px solid black; height:200px; overflow:auto; margin-bottom:5px; padding:5px;}
</style>
</head>
<body>

<h2>Willkommen, <span id="username">Lade...</span>!</h2>
<button onclick="logout()">Abmelden</button>

<h3>Chats</h3>
<div id="chatList"></div>
<input type="text" id="newChatName" placeholder="Neuen Chat erstellen">
<input type="text" id="newChatMembers" placeholder="Mitglieder-UIDs kommasepariert">
<button onclick="createChat()">Chat erstellen</button>

<h3>Chat: <span id="currentChatName">public</span></h3>
<div id="chatBox" class="chatBox"></div>
<input type="text" id="chatMsg" placeholder="Nachricht">
<button onclick="sendMsg()">Senden</button>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCp6Aon4b-sLmUdRaf3sdyKN0y4QK2Zil4",
  authDomain: "maelist-chat.firebaseapp.com",
  databaseURL: "https://maelist-chat-default-rtdb.firebaseio.com/",
  projectId: "maelist-chat",
  storageBucket: "maelist-chat.firebasestorage.app",
  messagingSenderId: "87392900284",
  appId: "1:87392900284:web:fd39fe7161bfa828976cb9",
  measurementId: "G-GK0KNPV152"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let username = null;
let uid = null;
let currentChatId = 'public';

// Auth prüfen & Username laden
auth.onAuthStateChanged(async user => {
  if(!user){ window.location.href = "index.html"; return; }
  uid = user.uid;
  const snap = await db.ref('users/' + uid).get();
  if(!snap.exists()){ alert("User nicht gefunden!"); auth.signOut(); return; }
  username = snap.val().username;
  document.getElementById('username').textContent = username;

  loadChats();
  openChat('public'); // Public Chat standardmäßig öffnen
});

// Abmelden
function logout(){
  auth.signOut().then(()=>window.location.href="index.html");
}

// Liste aller Chats laden (öffentliche + private, bei denen user Mitglied ist)
async function loadChats(){
  const snap = await db.ref('chats').get();
  const chatList = document.getElementById('chatList');
  chatList.innerHTML = "";
  snap.forEach(chatSnap => {
    const chatId = chatSnap.key;
    const members = chatSnap.child('members').val();
    if(chatId === 'public' || (members && members[uid])){
      const btn = document.createElement('button');
      btn.textContent = chatId;
      btn.onclick = ()=>openChat(chatId);
      chatList.appendChild(btn);
    }
  });
}

// Chat öffnen
function openChat(chatId){
  currentChatId = chatId;
  document.getElementById('currentChatName').textContent = chatId;
  document.getElementById('chatBox').innerHTML = "";

  const chatRef = db.ref(`chats/${chatId}/messages`);
  chatRef.off();
  chatRef.on('child_added', s=>{
    const m = s.val();
    const div = document.getElementById('chatBox');
    div.innerHTML += `<p><b>${m.from}:</b> ${m.text}</p>`;
    div.scrollTop = div.scrollHeight;
  });
}

// Nachricht senden
function sendMsg(){
  const text = document.getElementById('chatMsg').value;
  if(!text) return;
  const msg = {from: username, text: text, timestamp: Date.now()};
  db.ref(`chats/${currentChatId}/messages`).push(msg);
  document.getElementById('chatMsg').value = "";
}

// Neuen Chat erstellen
function createChat(){
  const name = document.getElementById('newChatName').value.trim();
  const membersInput = document.getElementById('newChatMembers').value.trim();
  if(!name || !membersInput){ alert("Name + Mitglieder eingeben"); return; }

  const membersArr = membersInput.split(',').map(u=>u.trim());
  const membersObj = {};
  membersArr.forEach(u=>membersObj[u]=true);
  membersObj[uid]=true; // immer sich selbst hinzufügen

  db.ref(`chats/${name}`).set({ members: membersObj, messages: {} }).then(()=>{
    loadChats();
    openChat(name);
    document.getElementById('newChatName').value="";
    document.getElementById('newChatMembers').value="";
  });
}
</script>
</body>
</html>
