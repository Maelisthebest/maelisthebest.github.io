<!DOCTYPE html>
<html>
<head>
    <title>Chat</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getDatabase, ref, set, get, push, onChildAdded, onValue, onDisconnect, off } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCp6Aon4b-sLmUdRaf3sdyKN0y4QK2Zil4",
            authDomain: "maelist-chat.firebaseapp.com",
            databaseURL: "https://maelist-chat-default-rtdb.firebaseio.com/",
            projectId: "maelist-chat",
            storageBucket: "maelist-chat.firebasestorage.app",
            messagingSenderId: "87392900284",
            appId: "1:87392900284:web:fd39fe7161bfa828976cb9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let uid, username, currentChat = "public", currentListenRef = null;

        onAuthStateChanged(auth, async (user) => {
            if (!user) { window.location.href = "index.html"; return; }
            uid = user.uid;
            const userSnap = await get(ref(db, "users/" + uid));
            username = userSnap.val()?.username || "Anonym";

            const onlineRef = ref(db, "online/" + uid);
            set(onlineRef, true);
            onDisconnect(onlineRef).remove();

            loadUsers();
            openChat("public");
        });

        function loadUsers() {
            onValue(ref(db, "users"), (snapshot) => {
                const list = document.getElementById("users");
                list.innerHTML = "";
                onValue(ref(db, "online"), (onlineSnap) => {
                    const onlineUsers = onlineSnap.val() || {};
                    list.innerHTML = "";
                    snapshot.forEach(child => {
                        if (child.key === uid) return;
                        const div = document.createElement("div");
                        div.style = "padding:8px; cursor:pointer; border-bottom:1px solid #eee;";
                        div.innerHTML = `<span style="color:${onlineUsers[child.key] ? 'lime' : 'gray'}">‚óè</span> ${child.val().username}`;
                        div.onclick = () => startPrivateChat(child.key);
                        list.appendChild(div);
                    });
                });
            });
        }

        async function startPrivateChat(otherUid) {
            const chatId = [uid, otherUid].sort().join("_");
            const chatRef = ref(db, "chats/" + chatId);
            const snap = await get(chatRef);
            if (!snap.exists()) {
                await set(chatRef, { members: { [uid]: true, [otherUid]: true } });
            }
            openChat(chatId);
        }

        window.openChat = function(chatId) {
            if (currentListenRef) off(currentListenRef);
            currentChat = chatId;
            const msgBox = document.getElementById("messages");
            msgBox.innerHTML = `<div style="text-align:center; color:gray;">--- Chat: ${chatId === 'public' ? 'Global' : 'Privat'} ---</div>`;

            const messagesRef = ref(db, `chats/${chatId}/messages`);
            currentListenRef = messagesRef;
            onChildAdded(messagesRef, (snapshot) => {
                const m = snapshot.val();
                const div = document.createElement("div");
                div.style = "margin-bottom:10px;";
                div.innerHTML = `<b style="color:#007bff">${m.from}:</b> ${m.text}`;
                msgBox.appendChild(div);
                msgBox.scrollTop = msgBox.scrollHeight;
            });
        }

        window.sendMessage = function() {
            const input = document.getElementById("msg");
            if (!input.value) return;
            push(ref(db, `chats/${currentChat}/messages`), {
                from: username,
                text: input.value,
                timestamp: Date.now()
            });
            input.value = "";
        }

        window.logout = () => signOut(auth);
    </script>
</head>
<body style="display:flex; height:100vh; font-family:Arial; margin:0; background:#f0f2f5;">
    <div style="width:250px; border-right:1px solid #ccc; background:white; display:flex; flex-direction:column;">
        <div style="padding:15px; background:#007bff; color:white; font-weight:bold;">Nutzer</div>
        <div id="users" style="flex:1; overflow:auto;"></div>
        <button onclick="openChat('public')" style="padding:15px; background:#e9ecef; border:none; cursor:pointer;">üåç Globaler Chat</button>
        <button onclick="logout()" style="padding:10px; background:#dc3545; color:white; border:none; cursor:pointer;">Abmelden</button>
    </div>
    <div style="flex:1; display:flex; flex-direction:column;">
        <div id="messages" style="flex:1; overflow:auto; padding:20px;"></div>
        <div style="padding:15px; background:white; border-top:1px solid #ccc; display:flex;">
            <input id="msg" style="flex:1; padding:10px; border:1px solid #ccc; border-radius:4px;" placeholder="Nachricht schreiben..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()" style="margin-left:10px; padding:10px 20px; background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer;">Senden</button>
        </div>
    </div>
</body>
</html>
